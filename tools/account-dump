#! /usr/bin/php
<?php

// Change your database settings here:
$db = mysql_connect("localhost", "planeshift", "planeshift") or die ("Unable to connect!"); // host, user, pass
mysql_select_db("planeshift", $db) or die("Could not select database");

/* helper functions */

function dump_sql($tableArray, $tableName, $dumpFirstColumn = TRUE)
{
    $outputQuery = "INSERT INTO $tableName VALUES (";
    //this is the id we use a default auto increment one
    if($dumpFirstColumn == FALSE)
        $outputQuery .= "0,";
    foreach($dumpFirstColumn == TRUE ? $tableArray : array_slice($tableArray,1) as $value)
    {
        $tmp = mysql_real_escape_string($value);
        $outputQuery .= "'$tmp',";
    }
    return substr($outputQuery,0,strlen($outputQuery)-1) . ");";
}

function dump_sql_rows($query, $tableName, $dumpFirstColumn = TRUE)
{
    $queryOutput = "";
    $queryRows = mysql_query($query) or die("Query error:" . mysql_error() . "\n");
    while($queryRow = mysql_fetch_row($queryRows))
    {
        $queryOutput .= dump_sql($queryRow, $tableName, $dumpFirstColumn) . "\n";
    }
    return $queryOutput;
}

function getAccountIDFromName($username)
{
    //search by username
    $accountID_query = mysql_query("SELECT id FROM accounts WHERE username = '$username'") 
                                   or die ("Query error:" . mysql_error() . "\n");

    if(mysql_num_rows($accountID_query) == 0)
        die("Account ".$username." not Found!\n");
        
    return mysql_result($accountID_query, 0, "id");
}

/*main function*/

$accountID = 0;

if($argc < 2)
{
    die("You need to specify an account id or username (usually the email)\n");
}

if(!is_numeric($argv[1]))
{
    $accountID = getAccountIDFromName($argv[1]);
}
else
{
    $accountID = $argv[1];
}


$account_query = mysql_query("SELECT * FROM accounts WHERE id = '$accountID'") or die ("Query error:" . mysql_error() . "\n");

if(mysql_num_rows($account_query) == 0)
    die("Account ".$argv[1]." not Found!\n");

$accountData = mysql_fetch_row($account_query);
echo "\n---------------- CUT HERE -----------------------\n\n";

$accountQueryOutput = dump_sql($accountData, "accounts") . "\n\n";

echo $accountQueryOutput;
    
$charactersRows = mysql_query("SELECT * FROM characters WHERE account_id = '$accountID'") or die("Query error:" . mysql_error() . "\n");

if(mysql_num_rows($charactersRows) == 0)
    die("Account ".$argv[1]." has no characters!\n");
    
while($characterRow = mysql_fetch_row($charactersRows))
{
    $characterID = $characterRow[0];
    $charactersQueryOutput = "\n\n" . dump_sql($characterRow, "characters") . "\n\n";
    echo $charactersQueryOutput;
    
    //dump character quests
    printf(dump_sql_rows("SELECT * FROM character_quests where player_id = '$characterID'", "character_quests"));
    //dump character skills
    printf(dump_sql_rows("SELECT * FROM character_skills where character_id = '$characterID'", "character_skills"));
    //dump character traits
    printf(dump_sql_rows("SELECT * FROM character_traits where character_id = '$characterID'", "character_traits"));
    //dump player spells
    printf(dump_sql_rows("SELECT * FROM player_spells where player_id = '$characterID'", "player_spells"));
    //dump items
    printf(dump_sql_rows("SELECT * FROM item_instances where char_id_owner = '$characterID'", "item_instances", FALSE));

    //TODO: Complete npc dumping
    //these will give results only with npc.
    //dump merchant_item_categories
    printf(dump_sql_rows("SELECT * FROM merchant_item_categories where player_id = '$characterID'", "merchant_item_categories"));
    
}

?>
